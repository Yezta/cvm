name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (leave empty to use VERSION file)'
        required: false
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(cat VERSION | tr -d '[:space:]')
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: JCVM v${{ steps.version.outputs.version }}
          body: |
            # JCVM v${{ steps.version.outputs.version }}
            
            Universal Development Tool Version Manager
            
            ## Installation
            
            ### Quick Install (Linux/macOS)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```
            
            ### Manual Install
            
            1. Download the appropriate binary for your platform below
            2. Extract the archive
            3. Move the `jcvm` binary to a directory in your PATH (e.g., `/usr/local/bin` or `~/.local/bin`)
            4. Make it executable: `chmod +x jcvm` (Linux/macOS only)
            5. Run `jcvm shell-init` to set up shell integration
            
            ### Platform-specific Downloads
            
            - **macOS (Apple Silicon)**: `jcvm-v${{ steps.version.outputs.version }}-aarch64-apple-darwin.tar.gz`
            - **macOS (Intel)**: `jcvm-v${{ steps.version.outputs.version }}-x86_64-apple-darwin.tar.gz`
            - **Linux (x86_64)**: `jcvm-v${{ steps.version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz`
            - **Linux (ARM64)**: `jcvm-v${{ steps.version.outputs.version }}-aarch64-unknown-linux-gnu.tar.gz`
            - **Windows (x86_64)**: `jcvm-v${{ steps.version.outputs.version }}-x86_64-pc-windows-msvc.zip`
            
            ## What's New
            
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
            
            ## Getting Started
            
            After installation:
            ```bash
            # Set up shell integration
            jcvm shell-init
            
            # Reload your shell
            source ~/.zshrc  # or ~/.bashrc
            
            # Install a tool
            jcvm install --tool java 21
            jcvm install --tool node 20
            jcvm install --tool python 3.12
            
            # Use a version
            jcvm use --tool java 21
            ```
            
            For more information, visit the [documentation](https://github.com/${{ github.repository }}).
          draft: false
          prerelease: false

  build:
    name: Build - ${{ matrix.target }}
    needs: prepare-release
    if: needs.prepare-release.outputs.upload_url != ''
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - target: x86_64-apple-darwin
            os: macos-latest
            cross: false
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            cross: false
            archive: tar.gz
          
          # Linux builds
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
            archive: tar.gz
          
          # Windows builds
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            cross: false
            archive: zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-target-

      - name: Build binary
        shell: bash
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      - name: Strip binary (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          strip target/${{ matrix.target }}/release/jcvm || true

      - name: Prepare archive (Unix)
        if: matrix.archive == 'tar.gz'
        shell: bash
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          ARCHIVE_NAME="jcvm-v${VERSION}-${{ matrix.target }}"
          mkdir -p "${ARCHIVE_NAME}"
          
          # Copy binary
          cp "target/${{ matrix.target }}/release/jcvm" "${ARCHIVE_NAME}/"
          
          # Copy documentation
          cp README.md LICENSE CHANGELOG.md "${ARCHIVE_NAME}/" || true
          
          # Create install script for Unix systems
          cat > "${ARCHIVE_NAME}/install.sh" << 'EOF'
          #!/usr/bin/env bash
          set -e
          
          INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          
          echo "Installing JCVM to ${INSTALL_DIR}..."
          mkdir -p "${INSTALL_DIR}"
          cp "${SCRIPT_DIR}/jcvm" "${INSTALL_DIR}/jcvm"
          chmod +x "${INSTALL_DIR}/jcvm"
          
          echo "âœ… JCVM installed successfully!"
          echo ""
          echo "Next steps:"
          echo "  1. Ensure ${INSTALL_DIR} is in your PATH"
          echo "  2. Run: jcvm shell-init"
          echo "  3. Reload your shell"
          echo ""
          echo "For help: jcvm --help"
          EOF
          chmod +x "${ARCHIVE_NAME}/install.sh"
          
          # Create tarball
          tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          echo "ARCHIVE_PATH=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_ENV

      - name: Prepare archive (Windows)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          $VERSION = "${{ needs.prepare-release.outputs.version }}"
          $ARCHIVE_NAME = "jcvm-v${VERSION}-${{ matrix.target }}"
          
          New-Item -ItemType Directory -Force -Path $ARCHIVE_NAME
          
          # Copy binary
          Copy-Item "target/${{ matrix.target }}/release/jcvm.exe" "$ARCHIVE_NAME/"
          
          # Copy documentation
          Copy-Item README.md, LICENSE, CHANGELOG.md "$ARCHIVE_NAME/" -ErrorAction SilentlyContinue
          
          # Create install script for Windows
          @"
          @echo off
          setlocal
          
          set "INSTALL_DIR=%USERPROFILE%\.local\bin"
          if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
          
          echo Installing JCVM to %INSTALL_DIR%...
          copy /Y "%~dp0jcvm.exe" "%INSTALL_DIR%\jcvm.exe"
          
          echo.
          echo JCVM installed successfully!
          echo.
          echo Next steps:
          echo   1. Ensure %INSTALL_DIR% is in your PATH
          echo   2. Run: jcvm shell-init
          echo   3. Reload your shell
          echo.
          echo For help: jcvm --help
          "@ | Out-File -FilePath "$ARCHIVE_NAME\install.bat" -Encoding ASCII
          
          # Create zip
          Compress-Archive -Path $ARCHIVE_NAME -DestinationPath "$ARCHIVE_NAME.zip"
          echo "ARCHIVE_PATH=$ARCHIVE_NAME.zip" >> $env:GITHUB_ENV
          echo "ARCHIVE_NAME=$ARCHIVE_NAME.zip" >> $env:GITHUB_ENV

      - name: Generate checksums
        shell: bash
        run: |
          if [ "${{ matrix.archive }}" = "tar.gz" ]; then
            sha256sum "${{ env.ARCHIVE_NAME }}" > "${{ env.ARCHIVE_NAME }}.sha256"
          else
            sha256sum "${{ env.ARCHIVE_NAME }}" > "${{ env.ARCHIVE_NAME }}.sha256"
          fi

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.prepare-release.outputs.upload_url }}
          asset_path: ./${{ env.ARCHIVE_NAME }}
          asset_name: ${{ env.ARCHIVE_NAME }}
          asset_content_type: application/octet-stream

      - name: Upload Checksum
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.prepare-release.outputs.upload_url }}
          asset_path: ./${{ env.ARCHIVE_NAME }}.sha256
          asset_name: ${{ env.ARCHIVE_NAME }}.sha256
          asset_content_type: text/plain

  update-install-script:
    name: Update Install Script URLs
    needs: [prepare-release, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update install.sh with release URL
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          REPO="${{ github.repository }}"
          
          # Update the default REPO_URL in install.sh if it has placeholder
          sed -i "s|REPO_URL=\"\${REPO_URL:-https://github.com/Yezta/cvm.git}\"|REPO_URL=\"\${REPO_URL:-https://github.com/${REPO}.git}\"|g" install.sh || true
          
          echo "Install script updated for release v${VERSION}"

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add install.sh || true
          git diff --staged --quiet || git commit -m "chore: update install script for release v${{ needs.prepare-release.outputs.version }}" || true
          git push || true
