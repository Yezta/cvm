name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          
          # Extract changelog for this version
          if [ -f CHANGELOG.md ]; then
            # Find the section for this version
            START_LINE=$(grep -n "## \[${VERSION}\]" CHANGELOG.md | head -1 | cut -d: -f1 || echo "0")
            
            if [ "$START_LINE" != "0" ]; then
              # Find the next version section
              NEXT_LINE=$(tail -n +$((START_LINE + 1)) CHANGELOG.md | grep -n "^## \[" | head -1 | cut -d: -f1 || echo "")
              
              if [ -n "$NEXT_LINE" ]; then
                END_LINE=$((START_LINE + NEXT_LINE - 1))
                sed -n "${START_LINE},${END_LINE}p" CHANGELOG.md > /tmp/release_notes.md
              else
                tail -n +${START_LINE} CHANGELOG.md > /tmp/release_notes.md
              fi
            else
              echo "## Changes" > /tmp/release_notes.md
              echo "" >> /tmp/release_notes.md
              echo "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details." >> /tmp/release_notes.md
            fi
          else
            echo "## Changes" > /tmp/release_notes.md
            echo "" >> /tmp/release_notes.md
            echo "Release v${VERSION}" >> /tmp/release_notes.md
          fi
          
          # Append installation instructions
          cat >> /tmp/release_notes.md << 'EOF'
          
          ---
          
          ## ðŸ“¦ Installation
          
          ### Quick Install (Linux/macOS)
          ```bash
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash
          ```
          
          ### Manual Installation
          
          1. Download the appropriate binary for your platform below
          2. Extract the archive
          3. Move the \`jcvm\` binary to a directory in your PATH
          4. Make it executable (Unix): \`chmod +x jcvm\`
          5. Run \`jcvm shell-init\` to set up shell integration
          
          ### ðŸŽ¯ Platform Downloads
          
          | Platform | Architecture | Download |
          |----------|--------------|----------|
          | macOS | Apple Silicon (M1/M2/M3) | \`jcvm-v${{ steps.get_version.outputs.version }}-aarch64-apple-darwin.tar.gz\` |
          | macOS | Intel (x86_64) | \`jcvm-v${{ steps.get_version.outputs.version }}-x86_64-apple-darwin.tar.gz\` |
          | Linux | x86_64 | \`jcvm-v${{ steps.get_version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz\` |
          | Linux | ARM64 | \`jcvm-v${{ steps.get_version.outputs.version }}-aarch64-unknown-linux-gnu.tar.gz\` |
          | Windows | x86_64 | \`jcvm-v${{ steps.get_version.outputs.version }}-x86_64-pc-windows-msvc.zip\` |
          
          ### ðŸ” Verify Downloads
          
          SHA256 checksums are provided for each download. Verify with:
          ```bash
          sha256sum -c jcvm-v${{ steps.get_version.outputs.version }}-<platform>.sha256
          ```
          
          ## ðŸš€ Getting Started
          
          ```bash
          # Initialize shell integration
          jcvm shell-init
          
          # Reload your shell or source your rc file
          source ~/.zshrc  # or ~/.bashrc
          
          # Install tools
          jcvm install --tool java 21
          jcvm install --tool node 20
          jcvm install --tool python 3.12
          
          # Switch versions
          jcvm use --tool java 21
          ```
          
          For more information, visit the [documentation](https://github.com/${{ github.repository }}).
          EOF

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: JCVM v${{ steps.get_version.outputs.version }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-release:
    name: Build - ${{ matrix.platform.name }}
    needs: create-release
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: macOS (Apple Silicon)
            os: macos-latest
            target: aarch64-apple-darwin
            cross: false
            archive: tar.gz
          - name: macOS (Intel)
            os: macos-latest
            target: x86_64-apple-darwin
            cross: false
            archive: tar.gz
          - name: Linux (x86_64)
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cross: false
            archive: tar.gz
          - name: Linux (ARM64)
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            cross: true
            archive: tar.gz
          - name: Windows (x86_64)
            os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false
            archive: zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Install cross-compilation tools
        if: matrix.platform.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Setup cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.platform.target }}
          cache-on-failure: true

      - name: Build binary
        shell: bash
        run: |
          if [ "${{ matrix.platform.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.platform.target }}
          else
            cargo build --release --target ${{ matrix.platform.target }}
          fi

      - name: Strip binary (Unix)
        if: matrix.platform.os != 'windows-latest'
        shell: bash
        run: |
          strip target/${{ matrix.platform.target }}/release/jcvm || true

      - name: Create Unix archive
        if: matrix.platform.archive == 'tar.gz'
        shell: bash
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          TARGET="${{ matrix.platform.target }}"
          ARCHIVE_NAME="jcvm-v${VERSION}-${TARGET}"
          
          mkdir -p "${ARCHIVE_NAME}"
          cp "target/${TARGET}/release/jcvm" "${ARCHIVE_NAME}/"
          cp README.md LICENSE CHANGELOG.md "${ARCHIVE_NAME}/" 2>/dev/null || true
          
          # Create install script
          cat > "${ARCHIVE_NAME}/install.sh" << 'EOFINSTALL'
          #!/usr/bin/env bash
          set -e
          
          INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          
          echo "Installing JCVM to ${INSTALL_DIR}..."
          mkdir -p "${INSTALL_DIR}"
          cp "${SCRIPT_DIR}/jcvm" "${INSTALL_DIR}/jcvm"
          chmod +x "${INSTALL_DIR}/jcvm"
          
          echo "âœ… JCVM installed successfully!"
          echo ""
          echo "Next steps:"
          echo "  1. Ensure ${INSTALL_DIR} is in your PATH"
          echo "  2. Run: jcvm shell-init"
          echo "  3. Reload your shell"
          EOFINSTALL
          chmod +x "${ARCHIVE_NAME}/install.sh"
          
          tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          sha256sum "${ARCHIVE_NAME}.tar.gz" > "${ARCHIVE_NAME}.tar.gz.sha256"
          
          echo "ASSET_PATH=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_ENV
          echo "CHECKSUM_PATH=${ARCHIVE_NAME}.tar.gz.sha256" >> $GITHUB_ENV

      - name: Create Windows archive
        if: matrix.platform.archive == 'zip'
        shell: pwsh
        run: |
          $VERSION = "${{ needs.create-release.outputs.version }}"
          $TARGET = "${{ matrix.platform.target }}"
          $ARCHIVE_NAME = "jcvm-v${VERSION}-${TARGET}"
          
          New-Item -ItemType Directory -Force -Path $ARCHIVE_NAME
          Copy-Item "target/${TARGET}/release/jcvm.exe" "$ARCHIVE_NAME/"
          Copy-Item README.md, LICENSE, CHANGELOG.md "$ARCHIVE_NAME/" -ErrorAction SilentlyContinue
          
          # Create install script
          @'
          @echo off
          setlocal
          
          set "INSTALL_DIR=%USERPROFILE%\.local\bin"
          if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
          
          echo Installing JCVM to %INSTALL_DIR%...
          copy /Y "%~dp0jcvm.exe" "%INSTALL_DIR%\jcvm.exe"
          
          echo.
          echo JCVM installed successfully!
          echo.
          echo Next steps:
          echo   1. Ensure %INSTALL_DIR% is in your PATH
          echo   2. Run: jcvm shell-init
          echo   3. Reload your shell
          '@ | Out-File -FilePath "$ARCHIVE_NAME\install.bat" -Encoding ASCII
          
          Compress-Archive -Path $ARCHIVE_NAME -DestinationPath "$ARCHIVE_NAME.zip"
          (Get-FileHash -Algorithm SHA256 "$ARCHIVE_NAME.zip").Hash.ToLower() + "  $ARCHIVE_NAME.zip" | Out-File -FilePath "$ARCHIVE_NAME.zip.sha256" -Encoding ASCII -NoNewline
          
          echo "ASSET_PATH=$ARCHIVE_NAME.zip" >> $env:GITHUB_ENV
          echo "CHECKSUM_PATH=$ARCHIVE_NAME.zip.sha256" >> $env:GITHUB_ENV

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            ${{ env.ASSET_PATH }}
            ${{ env.CHECKSUM_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post-release:
    name: Post-Release Tasks
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release summary
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ‰ Release v${VERSION} Published!
          
          ### ðŸ“¦ Artifacts Built
          - âœ… macOS (Apple Silicon)
          - âœ… macOS (Intel)
          - âœ… Linux (x86_64)
          - âœ… Linux (ARM64)
          - âœ… Windows (x86_64)
          
          ### ðŸ”— Links
          - [Release Page](https://github.com/${{ github.repository }}/releases/tag/v${VERSION})
          - [Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          
          ### ðŸ“¥ Quick Install
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash
          \`\`\`
          EOF
