name: Nightly Build

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: write

jobs:
  nightly:
    name: Nightly - ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # macOS builds
          - name: macOS (Apple Silicon)
            os: macos-latest
            target: aarch64-apple-darwin
            cross: false
          - name: macOS (Intel)
            os: macos-latest
            target: x86_64-apple-darwin
            cross: false
          # Linux builds
          - name: Linux (x86_64)
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cross: false
          - name: Linux (ARM64)
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            cross: true
          - name: Linux (ARMv7)
            os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            cross: true
          # Windows builds
          - name: Windows (x86_64)
            os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Install cross-compilation tools
        if: matrix.platform.cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.platform.target }}-nightly
          cache-on-failure: true

      - name: Generate nightly version
        id: version
        shell: bash
        run: |
          # Get base version from Cargo.toml
          BASE_VERSION=$(grep -m1 '^version = ' Cargo.toml | cut -d'"' -f2)
          
          # Get short commit SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Generate nightly version: base-nightly+sha
          NIGHTLY_VERSION="${BASE_VERSION}-nightly+${SHORT_SHA}"
          
          echo "version=${NIGHTLY_VERSION}" >> $GITHUB_OUTPUT
          echo "sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "ðŸŒ™ Nightly version: ${NIGHTLY_VERSION}"

      - name: Build binary
        shell: bash
        run: |
          if [ "${{ matrix.platform.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.platform.target }}
          else
            cargo build --release --target ${{ matrix.platform.target }}
          fi

      - name: Strip binary (Unix)
        if: matrix.platform.os != 'windows-latest'
        shell: bash
        run: strip target/${{ matrix.platform.target }}/release/jcvm || true

      - name: Prepare Unix archive
        if: matrix.platform.os != 'windows-latest'
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TARGET="${{ matrix.platform.target }}"
          ARCHIVE="jcvm-nightly-${TARGET}"
          
          mkdir -p "${ARCHIVE}"
          cp "target/${TARGET}/release/jcvm" "${ARCHIVE}/"
          cp README.md LICENSE CHANGELOG.md "${ARCHIVE}/" 2>/dev/null || true
          
          # Add nightly info
          cat > "${ARCHIVE}/NIGHTLY_INFO.txt" << EOF
          JCVM Nightly Build
          Version: ${VERSION}
          Commit: ${{ steps.version.outputs.sha }}
          Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Target: ${TARGET}
          
          âš ï¸ WARNING: This is a nightly build from the latest development code.
          It may contain bugs and experimental features. Use at your own risk.
          
          For stable releases, visit:
          https://github.com/${{ github.repository }}/releases
          EOF
          
          # Create archive and checksum
          tar czf "${ARCHIVE}.tar.gz" "${ARCHIVE}"
          sha256sum "${ARCHIVE}.tar.gz" | tee "${ARCHIVE}.tar.gz.sha256"
          
          echo "ASSET=${ARCHIVE}.tar.gz" >> $GITHUB_ENV
          echo "CHECKSUM=${ARCHIVE}.tar.gz.sha256" >> $GITHUB_ENV

      - name: Prepare Windows archive
        if: matrix.platform.os == 'windows-latest'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $TARGET = "${{ matrix.platform.target }}"
          $ARCHIVE = "jcvm-nightly-${TARGET}"
          
          New-Item -ItemType Directory -Force -Path $ARCHIVE
          Copy-Item "target/${TARGET}/release/jcvm.exe" "${ARCHIVE}/"
          Copy-Item README.md, LICENSE, CHANGELOG.md "${ARCHIVE}/" -ErrorAction SilentlyContinue
          
          # Add nightly info
          $nightlyInfo = @"
          JCVM Nightly Build
          Version: $VERSION
          Commit: ${{ steps.version.outputs.sha }}
          Built: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          Target: $TARGET
          
          âš ï¸ This is a nightly build from the latest development code.
          It may contain bugs and experimental features. Use at your own risk.
          
          For stable releases, visit:
          https://github.com/${{ github.repository }}/releases
          "@
          
          $nightlyInfo | Out-File -FilePath "${ARCHIVE}\NIGHTLY_INFO.txt" -Encoding UTF8
          
          # Create archive and checksum
          Compress-Archive -Path $ARCHIVE -DestinationPath "${ARCHIVE}.zip"
          (Get-FileHash -Algorithm SHA256 "${ARCHIVE}.zip").Hash.ToLower() + "  ${ARCHIVE}.zip" | Tee-Object -FilePath "${ARCHIVE}.zip.sha256"
          
          echo "ASSET=${ARCHIVE}.zip" >> $env:GITHUB_ENV
          echo "CHECKSUM=${ARCHIVE}.zip.sha256" >> $env:GITHUB_ENV

      - name: Upload nightly artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-${{ matrix.platform.target }}
          path: |
            ${{ env.ASSET }}
            ${{ env.CHECKSUM }}
          retention-days: 30

  summary:
    name: Nightly Build Summary
    needs: nightly
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸŒ™ Nightly Build Complete
          
          ### Build Status
          ${{ needs.nightly.result == 'success' && 'âœ… All builds succeeded' || 'âš ï¸ Some builds failed' }}
          
          ### Artifacts
          Nightly builds are available as workflow artifacts for 30 days.
          
          âš ï¸ **Note**: Nightly builds are experimental and may contain bugs.
          Use stable releases for production: https://github.com/${{ github.repository }}/releases
          
          ### Download with nightly.link
          Access nightly builds via: https://nightly.link/${{ github.repository }}/workflows/nightly/main
          EOF
